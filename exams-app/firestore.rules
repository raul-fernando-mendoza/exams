rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if false;
    } 
    match /organizations/{organizationID} {
      allow read: if true   
      allow read, write: if ( ('role-admin-' + resource.data.organization_id) in request.auth.token  )
      allow read, write:  if ( ('role-admin-' + request. resource.data.organization_id) in request.auth.token  )

    }
    match /materias/{materiaId} {
      function isAdmin(request) {
      	return ('role-admin-' + get(/databases/$(database)/documents/materias/$(materiaId)).data.organization_id) in request.auth.token
      }    
    	allow read: if true
      allow read, write: if ( ('role-admin-' + resource.data.organization_id) in request.auth.token  )
      allow read, write:  if ( ('role-admin-' + request.resource.data.organization_id) in request.auth.token  )
      
			match /{document=**} {    
        allow read, write: if isAdmin(request) 
        allow read: if request.auth != null
      }       
    } 
    match /exams/{examId} {
    	allow read: if false
      allow write: if false 
    } 
    match /careers/{careerId} {
      function isAdmin(request) {
      	return ('role-admin-' + get(/databases/$(database)/documents/careers/$(careerId)).data.organization_id) in request.auth.token
      }    
      allow read, write: if ( ('role-admin-' + resource.data.organization_id) in request.auth.token  )
      allow read, write: if ( ('role-admin-' + request.resource.data.organization_id) in request.auth.token  )
			allow read: if ( request.auth != null  ) 
			match /{document=**} {    
        allow read, write: if isAdmin(request)
        allow read: if request.auth != null
      }       
		}
    match /materiaEnrollments/{materiaEnrollmentId} {  
      allow read, write: if ( ('role-admin-' + resource.data.organization_id) in request.auth.token  )
      allow read, write: if ( ('role-admin-' + request.resource.data.organization_id) in request.auth.token  )
      allow read, write: if ( ('role-admin-' + request.resource.data.organization_id) in request.auth.token  )

			allow write: if ( request.auth.uid == request.resource.data.student_uid   ) 
      allow read,write: if ( request.auth.uid == resource.data.student_uid  ) 
    }   
    match /examGrades/{examGrade} {
      function isExamGradeEvaluator() {
        return request.auth.uid in get(/databases/$(database)/documents/examGrades/$(examGrade)).data.evaluators 
      }  
      function isExamGradeStudent() {
        return request.auth.uid == get(/databases/$(database)/documents/examGrades/$(examGrade)).data.student_uid
      }
      function isAdmin(request) {
      	return ('role-admin-' + get(/databases/$(database)/documents/examGrades/$(examGrade)).data.organization_id) in request.auth.token
      }
      allow read, write: if ( ('role-admin-' + resource.data.organization_id) in request.auth.token  )
      allow read, write: if ( ('role-admin-' + request.resource.data.organization_id) in request.auth.token  )
      allow read: if request.auth.uid == resource.data.evaluator_uid 
      allow read: if request.auth.uid == resource.data.student_uid 

			match /{document=**} {    
        allow read, write: if isAdmin(request)   
        allow read, update: if isExamGradeEvaluator() 
        allow read: if isExamGradeStudent()
      }      
    } 
    
    match /{path=**}/parameterGrades/{parameterGradesId} {    
      allow read, write, create: if ( request.auth.token.admin == true ) 
      allow read, update: if ( request.auth.uid == resource.data.evaluator_uid   )   
    }
		match /{path=**}/organization_members/{organizationMemberId} {    
      allow read: if request.auth.uid == resource.data.uid  
    }         
  }
}